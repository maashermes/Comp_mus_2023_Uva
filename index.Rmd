---
title: "Songbook classics"
author: "Maas Hermes"
date: "2023-03-01"
output: 
  flexdashboard::flex_dashboard:
    logo: TestLogo.png
    theme:
      version: 4
      bg: "#FFDE95"
      fg: "#000000"
      primary: "#FF95DE" 
      navbar-bg: "#9596FF"
      base_font:
        google: Prompt
      heading_font:
        google: Sen
      code_font:
        google: 
          # arguments to sass::font_google() 
          family: JetBrains Mono
          local: false
  storyboard: true
  
  
---

<link rel="TestLogo.png" href="TestLogo.png">

```{r setup, include=FALSE}

library(flexdashboard)
library(plotly)
library(tidyverse)
library(spotifyr)
library(dplyr)
library(compmus)
library(bslib)
library(tidymodels)
library(ggdendro)

thematic::thematic_rmd()
# load playlists
flyMe_play <- get_playlist_audio_features("", "52AGhbgpfzebmkZoZbLBHr")
bobOmb_play <- get_playlist_audio_features("", "0zf0XjYpSmXZPe7VlVrJI6")
knitr::opts_chunk$set(echo = FALSE)


#Sys.setenv(SPOTIFY_CLIENT_ID = 'a34037c68c8c4321ab292374b43edd48')
#Sys.setenv(SPOTIFY_CLIENT_SECRET = 'c27edddbb73b47e191cdb8613b60c69b')
#access_token <- get_spotify_access_token()
```

# page 0 {.storyboard}

### Introduction

Before anyone sees this: This is all very work in progress since I just started over with my flex dashboard so Im missing all the previous homework assignments. I do have a tempo oriented tab on page 2. So some feedback on that would be appreciated. Now on to the actual introduction:

Last year, “The 8-Bit Big Band” lead by composer and arranger Charlie Rosen won a Grammy for their arrangement of “Meta-Knights Revenge” from the 1996 video game “Kirby Super Star”. This was quite surprising for a lot of people, given the source material being from an over 20-year-old video game. This is not the only case though, since recently a lot of musicians arrange and cover pieces of music from old video games. Rosen noted in a [Forbes magazine interview](https://www.forbes.com/sites/darrynking/2020/01/20/exploring-the-great-video-game-songbook-with-charlie-rosen/?sh=112dfd0b343b) however, that are a lot of similarities between this current movement and of a movement of the past:

“In the past, people created these collections of music. For example, we refer to the Great American Songbook, which originated in American culture in the 20s, 30s and 40s. There are Broadway show tunes. Movie scores.
Today, there’s a whole new generation of people that grew up with a new kind of songbook – the Video Game Songbook: a collection of themes and melodies and music that we associate with the experience of playing video games. It’s a touchstone for a generation of people that grew up with digital media and interactive media, a big focal point of their upbringing.”
He further argues that there are similarities in the actual music of these collections. This is what I will be researching in this portfolio through computational analysis. To what extent can we see similarities in the music of the Great American Songbook, and the Video Game Songbook. 

To do this I will be looking at to of the most covered songs in these respective books: 
“Fly Me To The Moon (In Other Words)”, representing the Great American songbook, and “Bob-omb Battlefield”, representing the Video Game Songbook.

“In Other Words”, or now more commonly known as “Fly Me To The Moon”, was originally composed in 1954 by Bart Howard. It was originally composed as a cabaret ballad in 3/4  time. It is a 32-bar composition with an ABAB form. This version was written specifically for only piano and vocals. Some notable covers include the 1962 Joe Harnell arrangement which popularized the bossa-nova style for the song. Quincy Jones’ arrangement is notable for putting it in a even 4/4 time. Later in 1964, he worked with Frank Sinatra and Count Basie to make the most well known version of the song to date. This version is a bombastic big band swing arrangement in a 4/4 time. This version is the one most people think of as “the original” even though it is very different from the original 1954 composition.

“Bob-omb Battlefield” was composed in 1996 by Koji Kondo for the video game “Super Mario 64”. The 34-bar composition is originally written in the key of C major in 4/4 time. It originally used MIDI instruments due to the data storage limitations of older video game consoles. The original instrumentation puts a lot of emphasis on brass instruments. This instrumentation lends itself well to big-band/jazz arrangements, which is one of the reasons why it’s often covered by jazz musicians.


### Playlists

```{r, out.extra=c('allow="encrypted-media"', 'allowtransparency="true"', 'frameBorder="0"')}
knitr::include_url("https://open.spotify.com/embed/playlist/52AGhbgpfzebmkZoZbLBHr?utm_source=generator", height = "380")
```
  
```{r, out.extra=c('allow="encrypted-media"', 'allowtransparency="true"', 'frameBorder="0"')}
knitr::include_url("https://open.spotify.com/embed/playlist/0zf0XjYpSmXZPe7VlVrJI6?utm_source=generator", height = "380")
```


# Page 1 {.storyboard}

### Plot 1: Fly me to the moon

```{r}
wood <- 
    get_tidy_audio_analysis('081AHcLTz6opbo1V9XN8eL') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)
    
wood %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'euclidean')) %>% 
    compmus_gather_chroma %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = pitch_class, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    theme_minimal()
```

### Plot 2: Bob-omb Battlefield
```{r}
wood <- 
    get_tidy_audio_analysis('581IpQMQrx09Kn4YjiSlsr') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)
    
wood %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'euclidean')) %>% 
    compmus_gather_chroma %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = pitch_class, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    theme_minimal()
```

# Page 2: Tempo{.storyboard}

### Histogram of Tempi of the two songs

```{r}
both <-
  bind_rows(
    flyMe_play |> mutate(category = "Fly me to the moon"),
    bobOmb_play |> mutate(category = "Bob-omb battlefield")
  )

both |>
  ggplot(aes(x = tempo)) +
  geom_histogram(binwidth = 10) +
  facet_wrap(~category)
```

***
Looking at the distribution of tempo's we can make a few interesting observations:
Both songs seem to have a very clear mode. Most songs in the Fly me to the moon dataset seem to have a tempo around 80 bpm. For Bob-omb battlefield this seems to be around 120. With Fly Me To The Moon however, we have another peak around 120bpm. I personally think this is because of two songs that covers often use as a base: the 80 bpm original Bart Howard composition, or the 120bpm Frank Sinatra arrangement. A third group is the songs around 160 bpm. These songs are more similar to the faster bossa-nova version of the song popularized by Joe Harnell.

For Bob-omb battlefield there is not much to note expect for the fact that they arrengements dont stray that far from the original tempo compared to Fly Me To The Moon. Of course it is not fair to directly compare the two since the Fly Me To The Moon dataset is almost three times the size of the Bob-omb Battlefield soundtrack.

### Tempo curves for two songs

```{r}
## Fly me to the moon - Nat king Cole
natKingCole <-
  get_tidy_audio_analysis("2waiAcLQiqlX5bzvLtNUA0") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

## Fly me to the moon - Ella Fitzgerald
ellaFitz <-
  get_tidy_audio_analysis("7hKNhP1e4TuBYaxLgpVItK") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

## Bob-omb battlefield - Insaneintherainmusic2
insaneInTheRain2 <-
  get_tidy_audio_analysis("3qf0GH0TFCJ3nFxVKWuzql") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

## Bob-omb battlefield - The Consouls
consouls <-
  get_tidy_audio_analysis("6lCWumvyh102pgnpwBEhgn") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

## Bob-omb battlefield - Pedro Esparza
pedroEsparza <-
  get_tidy_audio_analysis("4jOcYDQnclBa5n7HYyEcKI") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

## Bob-omb battlefield - insaneintherain1
insaneintheRain1 <-
  get_tidy_audio_analysis("0i4fKtQP3EeS0a6VRXoGNX") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)


```

```{r}
compmus_long_distance(
  natKingCole |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  ellaFitz |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) |>
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Nat King Cole", y = "Ella Fitzgerald") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)
```

***

Although these two songs have the same general structure and chord progression, they are in a different key. Making it so we can not see anything on the similarity "curve".

### Similarity matrix for Insaneintherain's Year 1 and Pedro Esparza's covers
```{r}

compmus_long_distance(
  pedroEsparza |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  insaneintheRain1 |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) |>
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Pedro Esparza", y = "Insaneintherainmusic Year 1") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)
```

***
These two covers of Bob-omb Battlefield are very similar in form, and both follow the original composition very closely, which we can see in this graph by looking at the vague diagonal from the origin. The diagonal becomes even harder to see later in the song since in both arrangements a solo starts over the entire 32 bars, which in both songs are different. The arrangement by Insaneintherainmusic however continues for longer than Esparza's cover which explains the graph being greater in height than in length. In this second part you can still see some diagonals hinting at similarities, since this cover repeats the first half of the song.

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/0i4fKtQP3EeS0a6VRXoGNX" width="100%" height="85" frameBorder="0" allowtransparency="true" allow="encrypted-media" data-external="1"></iframe>

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/4jOcYDQnclBa5n7HYyEcKI" width="100%" height="85" frameBorder="0" allowtransparency="true" allow="encrypted-media" data-external="1"></iframe>

### Tempogram for Fly me to the moon
```{r}
allThatJazz <- get_tidy_audio_analysis("29V4I3HxF3lWitweGJ2m70")

allThatJazz |>
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) |>
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()
```

***
This instrumental rendition has quite the interesting structure tempo-wise. It starts of with a very slow rubato intro. Rubato is generally very hard for an tempogram to interpret as there is no clear tempo in the first place. Around the one minute 30 mark, the tempo changes drastically though. The piano now plays a high tempo, walking bass, bassline. This is a lot easier for the tempogram to interpret as we can see in the clear horizontal line.

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/29V4I3HxF3lWitweGJ2m70" width="100%" height="85" frameBorder="0" allowtransparency="true" allow="encrypted-media" data-external="1"></iframe>


### Tempogram for Bob-omb Battlefield
```{r}
insaneInTheRain7 <- get_tidy_audio_analysis("3qf0GH0TFCJ3nFxVKWuzql")

insaneInTheRain7 |>
  tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) |>
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()
```

***
Half way through the song there is a part where bars get repeated and a lot of slow down occurs. making it more difficult for the tempogram to now what bpm we are dealing with.

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/3qf0GH0TFCJ3nFxVKWuzql" width="100%" height="85" frameBorder="0" allowtransparency="true" allow="encrypted-media" data-external="1"></iframe>

# page 3: Clustering (Not working)

### CLustering of all songs


***
Due to exams I was not able to make this work properly. I would love if there was something someone can see just by looking at the code. Here is the code I tried:

allPlay <-
  bind_rows(
    bobOmb_play |> mutate(playlist = "Bob-omb Battlefield") |> slice_head(n = 20),
    flyMe_play |> mutate(playlist = "Fly Me To The Moon") |> slice_head(n = 20)
  ) |> 
  add_audio_analysis()

all_juice <-
  recipe(
    track.name ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo,
    data = all_Play
  ) |>
  step_center(all_predictors()) |>
  step_scale(all_predictors()) |> 
  # step_range(all_predictors()) |> 
  prep(all_Play |> mutate(track.name = str_trunc(track.name, 20))) |>
  juice() |>
  column_to_rownames("track.name")

all_dist <- dist(all_juice, method = "euclidean")

data_for_all_clustering <- all_dist |> 
  hclust(method = "average") |> # average for a balanced tree!
  dendro_data() 

playlist_data_for_join <- allPlay %>%
  select(track.name, playlist_name) %>%
  mutate(label = str_trunc(track.name, 20))

data_for_all_clustering$labels <- data_for_all_clustering$labels %>%
  left_join(playlist_data_for_join)

data_for_all_clustering$labels$label <- factor(data_for_all_clustering$labels$label)


data_for_all_clustering |>
  ggdendrogram() +
  geom_text(data = label(data_for_all_clustering), aes(x, y, 
                                   label=label, 
                                   hjust=0, 
                                   colour=playlist_name), size=3) +
  coord_flip() + 
  scale_y_reverse(expand=c(0.2, 0)) +
  theme(axis.line.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_rect(fill="white"),
        panel.grid=element_blank()) +
  labs(title = "Playlist Clustering") +
  guides(
    colour = guide_legend(
      title = "Playlist"
    )
  )


